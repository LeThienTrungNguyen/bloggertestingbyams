<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị Ngân Hàng - Chuyên Nghiệp</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Icon Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tải Chart.js (thư viện biểu đồ) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Thiết lập font Inter cho giao diện chuyên nghiệp */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Style cho thanh cuộn tùy chỉnh */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 0; /* Đã loại bỏ bo góc */
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f8fafc; /* slate-50 */
        }
        .sidebar-item-active {
            @apply bg-blue-600 text-white shadow-lg shadow-blue-500/50;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        /* Khởi tạo icon Lucide */
        [lucide] {
            stroke-width: 2;
            width: 20px;
            height: 20px;
        }

        /* --- Style cho Link Bị Vô Hiệu Hóa (Disabled) --- */
        .is-disabled {
            /* 1. Làm mờ chữ */
            @apply text-gray-400; 
            /* Đảm bảo màu chữ không thay đổi khi hover, ghi đè Tailwind */
            color: #9ca3af !important; 
            /* Đảm bảo không có hiệu ứng nền khi hover, ghi đè Tailwind */
            background-color: transparent !important;
        }

        /* 2. Hiển thị biểu tượng cấm thao tác khi hover */
        .is-disabled:hover {
            cursor: not-allowed !important;
        }
        
        /* Đảm bảo icon bên trong link bị disabled cũng là màu xám */
        .is-disabled [lucide] {
            @apply text-gray-400; 
        }

        /* --- Style cho Loading Spinner --- */
        .spinner {
            border-top-color: #3b82f6; /* blue-500 */
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Style cho Modal (Hộp thoại) --- */
        .modal-overlay {
            z-index: 1000; /* Đảm bảo modal ở trên cùng */
            transition: opacity 0.3s ease;
        }

        /* Thêm class tùy chỉnh để xuống dòng cho chuỗi dài */
        .break-text-word {
            word-break: break-all;
            white-space: normal !important; /* Ghi đè whitespace-nowrap nếu có */
        }
        
        /* Cần thiết lập lại text-align cho td để nội dung con hiển thị đúng */
        .modal-table td {
            vertical-align: top;
            text-align: right; /* Căn phải mặc định cho cột giá trị */
        }
        .modal-table td:first-child {
            text-align: left; /* Căn trái cho cột tên mục */
        }
        /* Style cho ô có thể click (mục dữ liệu) */
        .clickable-row:hover {
            background-color: #f5f7fa; /* hover:bg-gray-50 */
        }
        .clickable-cell {
            cursor: pointer;
            transition: color 0.1s;
        }
        .clickable-cell:hover {
            color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="flex min-h-screen">

    <!-- Thanh Sidebar (Menu điều hướng) -->
    <aside id="sidebar" class="w-64 bg-white p-4 flex flex-col justify-between transition-transform duration-300 ease-in-out transform -translate-x-full md:translate-x-0 fixed md:relative z-30 h-screen custom-scrollbar">
        <div class="flex flex-col">
            <!-- Logo/Tiêu đề (ĐÃ THAY ĐỔI) -->
            <div class="mb-8 border-b pb-4">
                <!-- Phần Logo và Tên - ĐÃ CẬP NHẬT DÙNG HÌNH ẢẢNH LOGO -->
                <div class="flex items-center">
                    <img src="https://whatthelogo.com/storage/logos/techcombank-108052.webp" alt="Techcombank Logo" class="w-full h-auto max-h-12 object-contain" onerror="this.src='https://via.placeholder.com/200x50?text=BANK+LOGO'"/>
                </div>
                <!-- Slogan Vượt trội > mỗi ngày - ĐÃ CẬP NHẬT FONT SIZE và FONT WEIGHT -->
                <p class="text-sm font-bold mt-2 text-center" style="color: #ff3333;">Vượt trội &gt; mỗi ngày</p>
            </div>

            <!-- Các mục điều hướng -->
            <nav class="space-y-2">
                <!-- Các mục HOẠT ĐỘNG -->
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 sidebar-item-active" data-page="tong_quan">
                    <i lucide="layout-dashboard" class="mr-3"></i>
                    Tổng Quan
                </a>
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700" data-page="quan_ly_khach_hang">
                    <i lucide="users" class="mr-3"></i>
                    Quản Lý Khách Hàng
                </a>
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700" data-page="giao_dich">
                    <i lucide="arrow-left-right" class="mr-3"></i>
                    Quản Lý Giao Dịch
                </a>

                <!-- Danh mục BỊ VÔ HIỆU HÓA: Hệ Thống & Vận Hành -->
                <div class="pt-2 border-t mt-2">
                    <p class="text-xs font-semibold uppercase text-gray-400 px-3 py-2">Hệ Thống & Vận Hành (Bảo trì)</p>
                </div>
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 is-disabled" data-page="quan_tri_tai_khoan">
                    <i lucide="shield-check" class="mr-3"></i>
                    Quản lý Tài khoản & Bảo mật
                </a>
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 is-disabled" data-page="phan_quyen">
                    <i lucide="git-branch" class="mr-3"></i>
                    Phân quyền Chi nhánh
                </a>
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 is-disabled" data-page="quan_ly_quang_cao">
                    <i lucide="megaphone" class="mr-3"></i>
                    Quản lý Quảng cáo
                </a>
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 is-disabled" data-page="quan_ly_yeu_cau">
                    <i lucide="clipboard-list" class="mr-3"></i>
                    Quản lý Yêu cầu
                </a>

                <!-- Danh mục BỊ VÔ HIỆU HÓA: Báo cáo & Cài Đặt -->
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 is-disabled" data-page="bao_cao_thong_ke">
                    <i lucide="bar-chart-3" class="mr-3"></i>
                    Báo cáo & Thống kê
                </a>
                <a href="#" class="sidebar-item group flex items-center p-3 font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 is-disabled" data-page="cai_dat">
                    <i lucide="settings" class="mr-3"></i>
                    Cài Đặt Hệ Thống
                </a>
            </nav>
        </div>

        <!-- Thông tin người dùng/Đăng xuất -->
        <div class="pt-4 border-t mt-4">
            <div class="flex items-center p-2 bg-gray-50">
                <img src="https://placehold.co/40x40/4f46e5/ffffff?text=AD" alt="Avatar" class="w-10 h-10 mr-3 rounded-full">
                <div class="text-sm">
                    <p class="font-semibold text-gray-800">Nguyễn Văn A</p>
                    <p class="text-xs text-gray-500">ADMIN_ID_987158926098163265</p>
                    <p class="text-xs font-medium text-indigo-600 mt-0.5">QUẢN TRỊ TỐI CAO</p>
                </div>
            </div>
            <button class="w-full mt-3 flex items-center justify-center p-2 text-red-600 bg-red-50 hover:bg-red-100 transition rounded-lg">
                <i lucide="log-out" class="mr-2"></i>
                Đăng Xuất
            </button>
        </div>
    </aside>

    <!-- Khu vực nội dung chính -->
    <main class="flex-1 p-4 md:p-8 overflow-y-auto">

        <!-- Header Bar (Thanh trên cùng) -->
        <header class="flex justify-between items-center mb-6">
            <h1 id="page-title" class="text-3xl font-extrabold text-gray-800">Tổng Quan</h1>
            <div class="flex items-center space-x-4">
                <!-- Nút mở/đóng sidebar cho mobile -->
                <button id="menu-toggle" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 transition rounded-lg">
                    <i lucide="menu"></i>
                </button>
            </div>
        </header>

        <!-- BANNER THÔNG BÁO BẢO TRÌ -->
        <div id="maintenance-alert" class="p-4 mb-6 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg flex items-start shadow-md">
            <i lucide="alert-triangle" class="w-5 h-5 mr-3 flex-shrink-0 text-yellow-600"></i>
            <div>
                <p class="font-semibold">Thông báo bảo trì hệ thống</p>
                <p class="text-sm">Hệ thống đang được bảo trì theo kế hoạch, không thể thực hiện một số tính năng nhất định.</p>
            </div>
        </div>

        <!-- Nội dung của từng trang sẽ được hiển thị ở đây -->
        <section id="content-area">
            <!-- Mặc định là trang Tổng Quan -->
        </section>

        <!-- Overlay cho mobile menu -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-0 z-20 transition-opacity duration-300 md:hidden pointer-events-none"></div>

    </main>

    <!-- Modal (Hộp thoại) Hiển Thị Số Liệu Dư Thuế -->
    <div id="taxModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95" role="dialog" aria-modal="true" aria-labelledby="taxModalTitle">
            <!-- Header Modal -->
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 id="taxModalTitle" class="text-xl font-bold text-gray-800 flex items-center">
                    <i lucide="wallet" class="mr-3 text-blue-600"></i> Dữ Liệu Tài Chính & Tiến Độ
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Content Modal -->
            <div class="p-5 space-y-4">
                <p class="text-gray-700">Thông tin chi tiết của khách hàng <span id="modalCustomerName" class="font-semibold text-blue-600">[Tên Khách Hàng]</span>:</p>

                <!-- Bảng Số Liệu Thuế Đã Sửa Lỗi Tràn Dữ Liệu -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 modal-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-1/2">Mục Dữ Liệu</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase w-1/2">Giá Trị</th>
                                <!-- Cột Trạng Thái/Tiến độ đã bị loại bỏ -->
                            </tr>
                        </thead>
                        <tbody id="taxTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                            <!-- Dữ liệu sẽ được điền bằng JS -->
                        </tbody>
                    </table>
                </div>

                <div class="bg-blue-50 p-3 rounded-lg flex justify-between items-center font-bold text-gray-800">
                    <span>Tổng Số Dư Hiện Có</span>
                    <!-- CẬP NHẬT: Xóa whitespace-nowrap và thêm break-text-word cho TotalTax -->
                    <span id="modalTotalTax" class="text-lg text-blue-600 break-text-word">0 VND</span>
                </div>
            </div>

            <!-- Footer Modal -->
            <div class="p-5 border-t border-gray-200 flex justify-end">
                <button onclick="closeModal()" class="bg-gray-200 text-gray-700 px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-300 transition">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <script>
        // Khởi tạo Lucide Icons (chuyển đổi các thẻ i[lucide] thành SVG)
        lucide.createIcons();

        // Cấu hình phân trang
        const ROWS_PER_PAGE = 7; // 7 hàng/trang
        let currentPage = 1;
        
        // New global state for filtering transactions
        let currentFilteredTransactions = []; 
        
        // Biến để quản lý timeout của việc tìm kiếm (tránh spam)
        let searchTimeout = null;

        // --- HÀM ĐỊNH DẠNG SỐ TÙY CHỈNH (ĐÃ CẬP NHẬT) ---
        /** * Định dạng số nguyên lớn, dùng dấu phẩy (,) làm dấu phân cách hàng nghìn.
         * Ví dụ: 123456789 -> "123,456,789"
         * @param {number} num - Số nguyên cần định dạng.
         * @returns {string} Chuỗi đã định dạng.
         */
        function formatNumberWithCommas(num) {
            // Kiểm tra nếu không phải số hoặc là giá trị không phải tiền tệ, trả về nguyên trạng
            if (typeof num !== 'number' || isNaN(num)) {
                return num;
            }
            // Chuyển số thành chuỗi và thêm dấu phẩy (,) sau mỗi 3 chữ số từ phải sang
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        /** Hàm tạo dữ liệu thuế giả lập ngẫu nhiên (ĐÃ CẬP NHẬT) */
        function generateTaxData(customerId) {
            
            // Xử lý dữ liệu đặc biệt cho Công Ty Công Nghệ Việt Nam (KH00004)
            if (customerId === 'KH00004') {
                const specialData = {
                    tax_report_balance: { value: 943120340100000, statusText: 'Đã báo cáo', statusIcon: 'check-circle' },
                    current_balance: { value: 943120340100000, statusText: 'Hiện có', statusIcon: 'trending-up',customClass: 'text-green-600 font-bold' },
                    pit_tax: { value: 675561000000, statusText: 'Nợ', statusIcon: 'x-circle' },
                    disbursement_progress: { value: 'Đã hoàn thành', statusText: 'Hoàn thành', statusIcon: 'clock' },
                    data_sync_progress: { value: 'Đã hoàn thành', statusText: 'Hoàn thành', statusIcon: 'check-circle' }, 
			data_report_quarter_1_2026 : {value : 'Đang tiến hành xác nhận<p>thuế TNCN. Hoàn thành vào <p>lúc 14/01/2026 15:03:11', statusText: 'Hoàn thành', statusIcon: 'check-circle'}
                };
                
                let totalDue = specialData.current_balance.value; 

                const details = [
                    // --- MỤC MỚI: PHÁP LÝ DOANH NGHIỆP (Ở TRÊN ĐẦU) ---
                    { name: 'Pháp lý doanh nghiệp', value: 'Đã hoàn thành', statusText: 'Hợp lệ', isCurrency: false, customClass: 'text-green-600 font-bold' },
                    
                    // SỬ DỤNG HÀM MỚI formatNumberWithCommas
                    { name: 'Số dư báo cáo thuế', value: formatNumberWithCommas(specialData.tax_report_balance.value) + ' VND', statusText: specialData.tax_report_balance.statusText, isCurrency: true,customClass: 'text-green-600 font-bold' },
                    { 
                        name: 'Số dư hiện tại', 
                        value: formatNumberWithCommas(specialData.current_balance.value) + ' VND', 
                        statusText: specialData.current_balance.statusText, 
                        isCurrency: true,
                        // THÊM: Dữ liệu để biết mục này có thể click được
                        isClickable: true,customClass: 'text-green-600 font-bold'
                    },
                    { name: 'Thuế thu nhập cá nhân', value: formatNumberWithCommas(specialData.pit_tax.value) + ' VND', statusText: specialData.pit_tax.statusText, isCurrency: true ,customClass: 'text-green-600 font-semibold'},
                    // Cập nhật class custom cho Tiến độ giải ngân: màu đen đậm
                    { name: 'Tiến độ giải ngân', value: specialData.disbursement_progress.value, statusText: specialData.disbursement_progress.statusText, isCurrency: false, customClass: 'text-green-600 font-semibold' },
                    // CẬP NHẬT: Tiến độ đồng bộ dữ liệu đã là chuỗi
                    { name: 'Tiến độ đồng bộ dữ liệu', value: specialData.data_sync_progress.value, statusText: specialData.data_sync_progress.statusText, isCurrency: false ,customClass: 'text-green-600 font-semibold'},
		    { name: 'Số liệu cổng thông tin điện tử', value: specialData.data_sync_progress.value, statusText: specialData.data_sync_progress.statusText, isCurrency: false ,customClass: 'text-green-600 font-semibold'},
		    { name: 'Báo cáo số liệu Quý I 2026', value: specialData.data_report_quarter_1_2026.value, statusText: specialData.data_report_quarter_1_2026.statusText, isCurrency: false ,customClass: 'text-yellow-600 font-semibold'},
                ];
                
                return { details, totalDueFormatted: formatNumberWithCommas(totalDue) + ' VND' };
            }
            
            // Logic tạo dữ liệu ngẫu nhiên cho các khách hàng khác
            const dataItems = [
                { id: 'tax_report_balance', name: 'Số dư báo cáo thuế', type: 'currency' },
                { id: 'current_balance', name: 'Số dư hiện tại', type: 'currency' },
                { id: 'pit_tax', name: 'Thuế thu nhập cá nhân', type: 'currency' },
                { id: 'disbursement_progress', name: 'Tiến độ giải ngân', type: 'progress' },
                { id: 'data_sync_progress', name: 'Tiến độ đồng bộ dữ liệu', type: 'progress' },
                { id: 'data_sync_progress1', name: 'Số liệu cổng thông tin điện tử', type: 'progress' },                		{ id: 'data_report_quarter_1_2026', name: 'Báo cáo số liệu Quý I 2026', type: 'progress' },
            ];
            
            let totalDue = 0;
            const details = [];
            const mockDates = ['10/12/2025 10:00:00', '12/11/2025 08:30:00', '01/01/2026 15:45:00'];

            dataItems.forEach(item => {
                let value = 0;
                let isClickable = false; // Mặc định không thể click

                if (item.type === 'currency') {
                    value = Math.floor(Math.random() * 1000000) * 1000 + (Math.random() > 0.9 ? 500000000 : 0);
                    if (Math.random() < 0.2) value = 0; 

                    if (item.id === 'current_balance') {
                        totalDue = value; 
                        isClickable = true; // Cho phép click vào Số dư hiện tại ngẫu nhiên
                    }
                    
                    let statusText = (item.id === 'pit_tax' && value > 0) ? 'Nợ' : 
                                     (item.id === 'pit_tax' && value === 0) ? 'Đã nộp' : 
                                     'Đã đối chiếu';

                    details.push({
                        name: item.name,
                        value: formatNumberWithCommas(value) + ' VND',
                        statusText: statusText,
                        isCurrency: true,
                        isClickable: isClickable 
                    });

                } else if (item.type === 'progress') {
                    const randomProgress = Math.floor(Math.random() * 101); // 0-100%
                    
                    if (item.id === 'disbursement_progress') {
                         const isComplete = randomProgress > 90;
                         const randomDate = mockDates[Math.floor(Math.random() * mockDates.length)];
                         const progressValue = isComplete ? `Đã giải ngân vào lúc ${randomDate}` : `Đang xử lý ${randomProgress}%`;
                         const progressClass = isComplete ? 'text-green-600 font-semibold' : 'text-yellow-600 font-medium';

                         details.push({
                            name: item.name,
                            value: progressValue,
                            statusText: isComplete ? 'Hoàn thành' : 'Đang xử lý', 
                            isCurrency: false,
                            customClass: progressClass
                        });
                    } else if (item.id === 'data_sync_progress') {
                        const isSynced = randomProgress > 80;
                        const syncDate = isSynced ? mockDates[Math.floor(Math.random() * mockDates.length)] : 'Chưa cập nhật';
                        const syncValue = isSynced ? `Đã hoàn thành. Cập nhật vào lúc ${syncDate}` : `Đang đồng bộ (${randomProgress}%)`;
                        const syncClass = isSynced ? 'text-green-600 font-bold' : 'text-gray-500';

                        details.push({
                            name: item.name,
                            value: syncValue,
                            statusText: isSynced ? 'Hoàn thành' : 'Đang chờ',
                            isCurrency: false,
                            customClass: syncClass
                        });
                    }
                }
            });

            return { details, totalDueFormatted: formatNumberWithCommas(totalDue) + ' VND' };
        }


        // --- Dữ liệu giả lập cho Khách hàng ---
        const INITIAL_CUSTOMERS = [
            { name: 'Nguyễn Minh Phụng', id: 'KH00001', accountNumber: '3467686868', type: 'Cá nhân', balance: '16,295,653 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Đỗ Công Bằng', id: 'KH00300', accountNumber: '9945673967', type: 'Cá nhân', balance: '21,169,735 VND', status: 'Hoạt động', biometrics: 'Chưa xác minh' },
            { name: 'Nguyễn Thị Thúy', id: 'KH03008', accountNumber: '19035001820019', type: 'Tiết kiệm cơ bản', balance: 'Không hiển thị số dư', status: 'Tạm khóa', biometrics: 'Đã xác minh' },
            { name: 'Công Ty Công Nghệ Việt Nam', id: 'KH00004', accountNumber: '30008686', type: 'Pháp lý Doanh nghiệp', balance: 'Không hiển thị số dư', status: 'Đã hoàn thành', biometrics: 'Đã xác minh' },
            { name: 'Trần Thanh Trình', id: 'KH00005', accountNumber: '19035694786013', type: 'Cá nhân', balance: 'Không hiển thị số dư', status: 'Tạm khóa', biometrics: 'Đã xác minh' },
            { name: 'Phạm Bích Ngọc', id: 'KH00006', accountNumber: '19034732011016', type: 'Cá nhân cao cấp', balance: '12,327,139,812 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Hồ Bảo Trân', id: 'KH00007', accountNumber: '148579717', type: 'Cá nhân', balance: '23,430,935 VND', status: 'Hoạt động', biometrics: 'Chưa xác minh' },
            { name: 'Nguyễn Thị Hiền', id: 'KH030096', accountNumber: '19034928562010', type: 'Cá nhân Cao cấp', balance: '307,956,431 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Tống Thị Hiền', id: 'KH30013576', accountNumber: '19034763287011', type: 'Tiết kiệm lâu dài', balance: '8,142,351,816 VND', status: 'Tạm khóa', biometrics: 'Đã xác minh' },
            { name: 'Bùi Văn Bình', id: 'KH000300948', accountNumber: '6666080596', type: 'Cá nhân', balance: '12,825,101 VND', status: 'Hoạt động', biometrics: 'Chưa xác minh' },

            { name: 'Ninh Thu Hương', id: 'KH00011', accountNumber: '5010666666', type: 'Cá nhân', balance: '3,176,362 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Nguyễn Văn Chung', id: 'KH00012', accountNumber: '501088888888', type: 'Cá nhân cao cấp', balance: '1,410,861,753 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Nguyễn Thị Thảo', id: 'KH00013', accountNumber: '501079797979', type: 'Cá nhân Cao cấp', balance: 'Không hiển thị số dư', status: 'Tạm khóa', biometrics: 'Chưa xác minh' },
            { name: 'Phan Nguyễn Uyển My', id: 'KH0003002', accountNumber: '5010333333', type: 'Cá nhân', balance: '9,108,835 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Lê Thị Hiền', id: 'KH0300634', accountNumber: '5010888889', type: 'Doanh nghiệp lớn', balance: '12,265,135,684 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Bùi Hoàng Sơn', id: 'KH300753', accountNumber: '5010123456', type: 'Tiết kiệm cơ bản', balance: 'Không hiển thị số dư', status: 'Tạm khóa', biometrics: 'Chưa xác minh' },
            { name: 'Nguyễn Thị Xuân', id: 'KH00017', accountNumber: '5010111111', type: 'Cá nhân', balance: '23,651,973 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Đỗ Thị Thảo', id: 'KH00018', accountNumber: '5010222222', type: 'Tiết kiệm lâu dài', balance: '75,351,253,197 VND', status: 'Hoạt động', biometrics: 'Chưa xác minh' },
            { name: 'Nguyễn Ngọc Tài', id: 'KH0030082', accountNumber: '5012345678', type: 'Cá nhân Cao cấp', balance: '150,632,486 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Trần Đại Hiệp', id: 'KH00020', accountNumber: '50103999999999', type: 'Cá nhân Cao cấp', balance: '23,015,992,157,822 VND', status: 'Hoạt động', biometrics: 'Đang trong quá trình xác minh' },
            { name: 'Lý Hồng Nhi', id: 'KH300967', accountNumber: '999967679', type: 'Cá nhân', balance: '23,157,839 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Nguyễn Thị Bích Liên', id: 'KH300812', accountNumber: '19071611605019', type: 'Cá nhân', balance: '2,124,932 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Tuấn Duy Quang', id: 'KH300975816', accountNumber: '19035521057016', type: 'Cá nhân', balance: '20,625,182 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Nguyễn Huỳnh Bảo Quyên', id: 'KH360930071', accountNumber: '19035521057016', type: 'Cá nhân', balance: '30,409,824 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Lê Hồng Mai', id: 'KH98300763', accountNumber: '19039982663010', type: 'Cá nhân', balance: '86,634,822 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Nguyễn Thị Thùy', id: 'KH3007963001', accountNumber: '19035001820019', type: 'Cá nhân', balance: '11,621,758 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
            { name: 'Lý Thị Thu Hường', id: 'KH510930014', accountNumber: '8833182866', type: 'Cá nhân', balance: '15,935,716 VND', status: 'Hoạt động', biometrics: 'Đã xác minh' },
        ].map(customer => ({
            ...customer,
            taxData: generateTaxData(customer.id) // Gắn dữ liệu thuế vào từng khách hàng
        }));
        
        /** Tạo thêm 980 khách hàng giả lập (tổng cộng 1000) */
        function generateAdditionalMockCustomers(startId, totalCount) {
            const newCustomers = [];
            const names = ['Quốc', 'Thị', 'Văn', 'Ngọc', 'Minh', 'Trang', 'Sơn', 'Hải', 'Linh', 'Bảo'];
            const customerTypes = ['Cá nhân Cao cấp', 'Tiết kiệm cơ bản', 'Doanh nghiệp nhỏ', 'Cá nhân', 'Doanh nghiệp'];
            const statuses = ['Hoạt động', 'Tạm khóa'];
            const biometrics = ['Đã xác minh', 'Chưa xác minh','Đang trong quá trình xác minh'];

            for (let i = startId; i <= totalCount; i++) {
                const idNum = String(i).padStart(5, '0');
                const id = `KH${idNum}`;
                const accountNumberBase = 5000000000;
                const accountNumber = String(accountNumberBase + (i - startId)).padStart(10, '0');
                
                const randomName = names[Math.floor(Math.random() * names.length)];
                const name = `Nguyễn Văn ${randomName}`;
                const type = customerTypes[Math.floor(Math.random() * customerTypes.length)];
                const balance = (Math.floor(Math.random() * 500) * 1000000 + 500000).toLocaleString('vi-VN') + ' VND';
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const bio = biometrics[Math.floor(Math.random() * biometrics.length)];

                newCustomers.push({ name, id, accountNumber, type, balance, status, biometrics: bio, taxData: generateTaxData(id) });
            }
            return newCustomers;
        }

        // TẠO TỔNG CỘNG 1000 KHÁCH HÀNG
        const ADDITIONAL_CUSTOMERS = generateAdditionalMockCustomers(INITIAL_CUSTOMERS.length + 1, 1000);
        const MOCK_CUSTOMERS = [...INITIAL_CUSTOMERS, ...ADDITIONAL_CUSTOMERS]; 

        // Map khách hàng theo ID để dễ dàng tìm kiếm
        const CUSTOMER_MAP = MOCK_CUSTOMERS.reduce((map, customer) => {
            map[customer.id] = customer;
            return map;
        }, {});


        // --- Dữ liệu giả lập cho Giao dịch (1000 mục) ---
        function generateMockTransactions(count) {
            const transactions = [];
            const names = ['Lê Văn Bình', 'Nguyễn Thu Phương', 'Phạm Minh Toàn', 'Đỗ Xuân Hợp', 'Trần Kim Ngân', 'Vũ Đức Thắng'];
            const types = ['Chuyển khoản', 'Rút tiền ATM', 'Thanh toán hóa đơn', 'Nhận tiền', 'Thanh toán thẻ tín dụng'];
            const statuses = ['Thành công', 'Thất bại', 'Đang chờ'];
            const amounts = [100000, 500000, 1000000, 2500000, 5000000, 10000000, 50000000];
            
            for (let i = 1; i <= count; i++) {
                const id = `TXN${String(1000 + i).padStart(4, '0')}`;
                const date = new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000 - Math.floor(Math.random() * 24 * 60 * 60 * 1000));
                const time = `${date.toISOString().slice(0, 10)} ${date.toTimeString().slice(0, 5)}`;
                
                const sender = Math.random() < 0.8 ? `KH${String(Math.floor(Math.random() * 1000) + 1).padStart(5, '0')}` : names[Math.floor(Math.random() * names.length)];
                const recipient = Math.random() < 0.8 ? `KH${String(Math.floor(Math.random() * 1000) + 1).padStart(5, '0')}` : 'Ngân hàng khác';
                
                const amountValue = amounts[Math.floor(Math.random() * amounts.length)];
                const type = types[Math.floor(Math.random() * types.length)];
                const isDebit = ['Chuyển khoản', 'Rút tiền ATM', 'Thanh toán hóa đơn', 'Thanh toán thẻ tín dụng'].includes(type);
                const amount = `${isDebit ? '-' : '+'}${amountValue.toLocaleString('vi-VN')} VND`;
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                transactions.push({ id, time, sender, recipient, type, amount, status, isDebit });
            }
            return transactions.sort((a, b) => new Date(b.time.replace(' ', 'T')) - new Date(a.time.replace(' ', 'T'))); 
        }

        const MOCK_TRANSACTIONS = generateMockTransactions(1000);

        // Định nghĩa cấu trúc nội dung cho từng trang (mô phỏng)
        const pages = {
            tong_quan: {
                title: "Tổng Quan",
                getContent: () => `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        ${createStatCard('Tổng Số Khách Hàng', MOCK_CUSTOMERS.length.toLocaleString('vi-VN')+'+', 'users', 'blue', '+5.2% so với tháng trước')}
                        ${createStatCard('Dư Nợ Cho Vay', '6.4 Tỉ USD', 'hand-coins', 'green', 'Tăng 8.1%')}
                        ${createStatCard('Giao Dịch Hôm Nay', '4,870', 'arrow-left-right', 'orange', '35 Giao dịch bất thường')}
                        ${createStatCard('Tài Sản Ròng', '850 Triệu USD', 'piggy-bank', 'teal', 'Đã đạt mục tiêu 90%')}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Biểu đồ Dòng Tiền & Lợi Nhuận (Sử dụng Chart.js) -->
                        <div class="lg:col-span-2 bg-white p-6 card-shadow rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Biểu Đồ Dòng Tiền & Lợi Nhuận (6 Tháng)</h2>
                            <div class="h-64">
                                <canvas id="revenueChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-500 mt-4">Dữ liệu giả lập, cập nhật theo thời gian thực.</p>
                        </div>

                        <!-- Danh sách các giao dịch gần đây -->
                        <div class="bg-white p-6 card-shadow rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Giao Dịch Gần Đây</h2>
                            <ul class="space-y-4 text-sm">
                                ${createTransactionItem('Nguyễn Thị Bình', 'Chuyển khoản', '-$5,200', 'red')}
                                ${createTransactionItem('Công Ty TNHH Mai Trang', 'Nhận tiền thanh toán', '+$15,000', 'green')}
                                ${createTransactionItem('Trần Văn Đức', 'Rút tiền ATM', '-$500', 'red')}
                                ${createTransactionItem('Nguyễn Hoàng Yến', 'Thanh toán hóa đơn', '-$150', 'red')}
                                ${createTransactionItem('Trần Bình Lưu', 'Gửi tiền', '+$50,000', 'green')}
                            </ul>
                            <a href="#" class="mt-4 block text-blue-600 hover:text-blue-700 font-medium text-sm">Xem tất cả giao dịch &rarr;</a>
                        </div>
                    </div>
                `
            },
            quan_ly_khach_hang: {
                title: "Quản Lý Khách Hàng",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                            <h2 class="text-xl font-semibold text-gray-800">Danh Sách Khách Hàng</h2>
                            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                                <div class="relative w-full sm:w-96">
                                    <input type="text" id="customerSearch" placeholder="Tìm kiếm theo ID hoặc Số Tài Khoản" 
                                           class="py-2 pl-10 pr-4 w-full border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" 
                                           oninput="handleCustomerSearch(this.value)">
                                    <i lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                                <button class="bg-gray-400 text-gray-700 px-4 py-2 text-sm font-medium transition flex items-center justify-center rounded-lg sm:w-auto cursor-not-allowed" disabled>
                                    <i lucide="plus" class="mr-1 w-4 h-4"></i> Thêm Khách Hàng Mới (Bảo trì)
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto custom-scrollbar relative">
                            <div id="loadingOverlay" class="absolute inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-10 hidden transition-opacity duration-300">
                                <div class="flex flex-col items-center">
                                    <div class="spinner w-8 h-8 border-4 border-gray-200 rounded-full mb-3"></div>
                                    <p class="text-blue-600 font-medium">Đang tìm kiếm khách hàng...</p>
                                </div>
                            </div>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        ${createTableHeader('Tên Khách Hàng')}
                                        ${createTableHeader('ID Khách Hàng')}
                                        ${createTableHeader('Số Tài Khoản')}
                                        ${createTableHeader('Loại Tài Khoản')}
                                        ${createTableHeader('Số Dư')}
                                        ${createTableHeader('Trạng Thái')}
                                        ${createTableHeader('Sinh trắc học')}
                                        ${createTableHeader('Hành Động')}
                                    </tr>
                                </thead>
                                <tbody id="customerTableBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            </table>
                        </div>

                        <div id="customerPagination" class="mt-4 flex flex-col sm:flex-row justify-between items-center text-sm text-gray-600 space-y-4 sm:space-y-0"></div>
                    </div>
                `
            },
            giao_dich: {
                title: "Quản Lý Giao Dịch",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Lọc và Tìm Kiếm Giao Dịch</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <input type="date" id="transactionDateFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <select id="transactionTypeFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Tất cả loại giao dịch</option>
                                <option value="Chuyển khoản">Chuyển khoản</option>
                                <option value="Rút tiền ATM">Rút tiền ATM</option>
                                <option value="Thanh toán hóa đơn">Thanh toán hóa đơn</option>
                                <option value="Nhận tiền">Nhận tiền</option>
                                <option value="Thanh toán thẻ tín dụng">Thanh toán thẻ tín dụng</option>
                            </select>
                            <select id="transactionStatusFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Tất cả trạng thái</option>
                                <option value="Thành công">Thành công</option>
                                <option value="Thất bại">Thất bại</option>
                                <option value="Đang chờ">Đang chờ</option>
                            </select>
                            <button id="applyFilterBtn" onclick="applyTransactionFilters()" class="bg-blue-600 text-white px-4 py-2 text-sm font-medium hover:bg-blue-700 transition rounded-lg">Áp Dụng Lọc</button>
                        </div>
                        <h3 class="text-lg font-medium text-gray-700 mb-4">Bảng Giao Dịch Chi Tiết (${MOCK_TRANSACTIONS.length.toLocaleString('vi-VN')} Giao dịch gần nhất)</h3>
                        <div class="overflow-x-auto custom-scrollbar relative">
                            <div id="transactionLoadingOverlay" class="absolute inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-10 hidden transition-opacity duration-300">
                                <div class="flex flex-col items-center">
                                    <div class="spinner w-8 h-8 border-4 border-gray-200 rounded-full mb-3"></div>
                                    <p class="text-blue-600 font-medium">Đang xử lý dữ liệu giao dịch...</p>
                                </div>
                            </div>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        ${createTableHeader('ID Giao Dịch')}
                                        ${createTableHeader('Thời Gian')}
                                        ${createTableHeader('Khách Hàng Gửi')}
                                        ${createTableHeader('Khách Hàng Nhận')}
                                        ${createTableHeader('Số Tiền')}
                                        ${createTableHeader('Trạng Thái')}
                                        ${createTableHeader('Chi Tiết')}
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            </table>
                        </div>
                        <div id="transactionPagination" class="mt-4 flex flex-col sm:flex-row justify-between items-center text-sm text-gray-600 space-y-4 sm:space-y-0"></div>
                    </div>
                `
            },
            quan_tri_tai_khoan: {
                title: "Quản lý Tài khoản & Bảo mật (Bảo trì)",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow space-y-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">Thông Báo</h2>
                        <p class="text-red-500 font-medium text-lg">Tính năng này đã bị vô hiệu hóa do hệ thống đang được bảo trì. Vui lòng thử lại sau.</p>
                        <i lucide="x-circle" class="w-12 h-12 text-red-500 mx-auto block"></i>
                    </div>
                `
            },
            phan_quyen: {
                title: "Phân quyền Chi nhánh (Bảo trì)",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow space-y-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">Thông Báo</h2>
                        <p class="text-red-500 font-medium text-lg">Tính năng này đã bị vô hiệu hóa do hệ thống đang được bảo trì. Vui lòng thử lại sau.</p>
                        <i lucide="x-circle" class="w-12 h-12 text-red-500 mx-auto block"></i>
                    </div>
                `
            },
            quan_ly_quang_cao: {
                title: "Quản lý Quảng cáo (Bảo trì)",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow space-y-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">Thông Báo</h2>
                        <p class="text-red-500 font-medium text-lg">Tính năng này đã bị vô hiệu hóa do hệ thống đang được bảo trì. Vui lòng thử lại sau.</p>
                        <i lucide="x-circle" class="w-12 h-12 text-red-500 mx-auto block"></i>
                    </div>
                `
            },
            quan_ly_yeu_cau: {
                title: "Quản lý Yêu cầu (Bảo trì)",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow space-y-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">Thông Báo</h2>
                        <p class="text-red-500 font-medium text-lg">Tính năng này đã bị vô hiệu hóa do hệ thống đang được bảo trì. Vui lòng thử lại sau.</p>
                        <i lucide="x-circle" class="w-12 h-12 text-red-500 mx-auto block"></i>
                    </div>
                `
            },
            bao_cao_thong_ke: {
                title: "Báo cáo & Thống kê (Bảo trì)",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow space-y-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">Thông Báo</h2>
                        <p class="text-red-500 font-medium text-lg">Tính năng này đã bị vô hiệu hóa do hệ thống đang được bảo trì. Vui lòng thử lại sau.</p>
                        <i lucide="x-circle" class="w-12 h-12 text-red-500 mx-auto block"></i>
                    </div>
                `
            },
            cai_dat: {
                title: "Cài Đặt Hệ Thống (Bảo trì)",
                getContent: () => `
                    <div class="bg-white p-6 card-shadow space-y-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">Thông Báo</h2>
                        <p class="text-red-500 font-medium text-lg">Tính năng này đã bị vô hiệu hóa do hệ thống đang được bảo trì. Vui lòng thử lại sau.</p>
                        <i lucide="x-circle" class="w-12 h-12 text-red-500 mx-auto block"></i>
                    </div>
                `
            }
        };

        // --- Hàm tạo UI components ---
        function createStatCard(title, value, icon, color, footer) {
            const colorMap = {
                blue: { bg: 'bg-blue-500', text: 'text-blue-500', iconBg: 'bg-blue-100', border: 'border-blue-500' },
                green: { bg: 'bg-green-500', text: 'text-green-500', iconBg: 'bg-green-100', border: 'border-green-500' },
                orange: { bg: 'bg-orange-500', text: 'text-orange-500', iconBg: 'bg-orange-100', border: 'border-orange-500' },
                teal: { bg: 'bg-teal-500', text: 'text-teal-500', iconBg: 'bg-teal-100', border: 'border-teal-500' }
            };
            const c = colorMap[color] || colorMap.blue;

            return `
                <div class="bg-white p-6 card-shadow border-l-4 ${c.border} rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-medium text-gray-500">${title}</h3>
                        <div class="p-2 ${c.iconBg} ${c.text} rounded-full">
                            <i lucide="${icon}"></i>
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900">${value}</p>
                    <p class="text-xs mt-2 text-gray-500">${footer}</p>
                </div>
            `;
        }

        function createTransactionItem(name, type, amount, color) {
            const amountClass = color === 'red' ? 'text-red-600' : 'text-green-600';
            const icon = color === 'red' ? 'arrow-up-right' : 'arrow-down-left';

            return `
                <li class="flex justify-between items-center py-2 border-b last:border-b-0">
                    <div class="flex items-center">
                        <div class="p-2 bg-gray-100 mr-3 text-gray-600 rounded-full">
                            <i lucide="${icon}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${name}</p>
                            <p class="text-xs text-gray-500">${type}</p>
                        </div>
                    </div>
                    <span class="${amountClass} font-semibold">${amount}</span>
                </li>
            `;
        }

        function createTableHeader(title) {
            return `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${title}</th>`;
        }

        /** Cập nhật: Thêm hàm gọi showTaxDetails() vào nút Xem */
        function createCustomerRow(customer) {
            const { name, id, accountNumber, type, balance, status, biometrics } = customer;
            const statusColor = (status === 'Hoạt động' || status === 'Đã hoàn thành') ? 'bg-green-100 text-green-800' : (status === 'Tạm khóa' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');
            // Cập nhật: Thêm điều kiện || cho biometrics
            const isVerified = biometrics === 'Đã xác minh' || biometrics === 'Đã xác minh. Cập nhật vào lúc 01/12/2025 10:08:32';
            const bioColor = isVerified ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

            return `
                <tr class="customer-row" data-customer-id="${id}">
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-500">${id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600 font-mono">${accountNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-500">${type}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-semibold">${balance}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold ${statusColor} rounded-full">${status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold ${bioColor} rounded-full">${biometrics}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <!-- Cập nhật nút Xem để mở Modal -->
                        <button onclick="showTaxDetails('${id}')" class="text-blue-600 hover:text-blue-800 mr-3">Xem</button>
                        <button class="text-red-600 hover:text-red-900">Xóa</button>
                    </td>
                </tr>
            `;
        }
        
        function createTransactionRow(txn) {
            const { id, time, sender, recipient, amount, status, isDebit } = txn;
            let statusClass;
            switch (status) {
                case 'Thành công': statusClass = 'bg-green-100 text-green-800'; break;
                case 'Thất bại': statusClass = 'bg-red-100 text-red-800'; break;
                default: statusClass = 'bg-yellow-100 text-yellow-800'; break;
            }
            const amountClass = isDebit ? 'text-red-600' : 'text-green-600';

            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-500">${id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-500">${time}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-700">${sender}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${recipient}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-semibold ${amountClass}">${amount}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold ${statusClass} rounded-full">${status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap"><button class="text-blue-600 hover:text-blue-800">Xem</button></td>
                </tr>
            `;
        }

        let revenueChartInstance = null;
        function initializeChart(pageKey) {
            if (pageKey === 'tong_quan') {
                const ctx = document.getElementById('revenueChart');
                if (ctx) {
                    if (revenueChartInstance) {
                        revenueChartInstance.destroy();
                    }

                    revenueChartInstance = new Chart(ctx, {
                        type: 'line', 
                        data: {
                            labels: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6'],
                            datasets: [
                                {
                                    type: 'bar', 
                                    label: 'Lợi Nhuận Gộp (Triệu USD)',
                                    data: [55, 60, 75, 80, 70, 95], 
                                    backgroundColor: 'rgba(59, 130, 246, 0.8)', 
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 1,
                                    borderRadius: 4,
                                },
                                {
                                    type: 'line', 
                                    label: 'Dòng Tiền Thuần (Triệu USD)',
                                    data: [65, 80, 70, 90, 85, 110], 
                                    fill: false,
                                    borderColor: 'rgb(16, 185, 129)', 
                                    tension: 0.3, 
                                    pointBackgroundColor: 'rgb(16, 185, 129)',
                                    pointRadius: 5
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, 
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Giá trị (Triệu USD)',
                                        font: {
                                            family: 'Inter',
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }
        
        function renderCustomerTable(customers, page = 1) {
            const tableBody = document.getElementById('customerTableBody');
            const paginationDiv = document.getElementById('customerPagination');
            
            if (!tableBody || !paginationDiv) return;

            document.getElementById('loadingOverlay').classList.add('hidden');

            const totalRows = customers.length;
            const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
            const start = (page - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            const paginatedCustomers = customers.slice(start, end);

            if (paginatedCustomers.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500 text-lg">Không tìm thấy khách hàng nào phù hợp với điều kiện tìm kiếm.</td></tr>`;
            } else {
                 tableBody.innerHTML = paginatedCustomers.map(createCustomerRow).join('');
            }

            let paginationHtml = '';
            const displayedCount = Math.min(end, totalRows) - start;
            paginationHtml += `<span>Hiển thị ${start + 1} đến ${start + displayedCount} của ${totalRows} Khách hàng (Tổng cộng ${MOCK_CUSTOMERS.length.toLocaleString('vi-VN')} trong hệ thống)</span>`;

            paginationHtml += `<div class="space-x-1 flex flex-wrap justify-center sm:justify-end">`;
            paginationHtml += `<button onclick="goToCustomerPage(${page - 1})" class="px-3 py-1 border hover:bg-gray-100 rounded-lg ${page === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${page === 1 ? 'disabled' : ''}>Trước</button>`;
            
            const siblingCount = 1;
            const ellipsis = `<span class="px-3 py-1 text-gray-500">...</span>`;
            let pagesArray = [];
            const pagesToShow = new Set();
            pagesToShow.add(1);
            for (let i = page - siblingCount; i <= page + siblingCount; i++) {
                if (i > 1 && i < totalPages) {
                    pagesToShow.add(i);
                }
            }
            if (totalPages > 1) {
                pagesToShow.add(totalPages);
            }
            if (totalPages > 4) {
                 pagesToShow.add(2);
                 if (totalPages - 1 > 2) {
                    pagesToShow.add(totalPages - 1);
                 }
            }
            pagesArray = Array.from(pagesToShow).sort((a, b) => a - b);
            
            let lastPage = 0;
            pagesArray.forEach(p => {
                if (lastPage !== 0 && p > lastPage + 1) {
                    paginationHtml += ellipsis;
                }
                const activeClass = p === page ? 'bg-blue-600 text-white' : 'hover:bg-gray-100';
                paginationHtml += `<button onclick="goToCustomerPage(${p})" class="px-3 py-1 border ${activeClass} rounded-lg">${p}</button>`;
                lastPage = p;
            });

            paginationHtml += `<button onclick="goToCustomerPage(${page + 1})" class="px-3 py-1 border hover:bg-gray-100 rounded-lg ${page >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${page >= totalPages ? 'disabled' : ''}>Tiếp</button>`;
            paginationHtml += `</div>`;
            
            paginationDiv.innerHTML = paginationHtml;
            currentPage = page;
        }

        window.goToCustomerPage = function(page) {
            const searchValue = document.getElementById('customerSearch')?.value || '';
            const lowerSearchValue = searchValue.toLowerCase();

            const filteredData = MOCK_CUSTOMERS.filter(c => 
                c.id.toLowerCase().includes(lowerSearchValue) || 
                c.accountNumber.toLowerCase().includes(lowerSearchValue)
            );

            const totalPages = Math.ceil(filteredData.length / ROWS_PER_PAGE);
            if (page >= 1 && page <= totalPages) {
                renderCustomerTable(filteredData, page);
            }
        }
        
        window.handleCustomerSearch = function(searchValue) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (searchTimeout) clearTimeout(searchTimeout);
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');

            searchTimeout = setTimeout(() => {
                const lowerSearchValue = searchValue.toLowerCase();
                const filteredData = MOCK_CUSTOMERS.filter(c => 
                    c.id.toLowerCase().includes(lowerSearchValue) || 
                    c.accountNumber.toLowerCase().includes(lowerSearchValue)
                );
                renderCustomerTable(filteredData, 1); 
            }, 1500); 
        }

        window.applyTransactionFilters = function() {
            const dateInput = document.getElementById('transactionDateFilter');
            const typeInput = document.getElementById('transactionTypeFilter');
            const statusInput = document.getElementById('transactionStatusFilter');
            const loadingOverlay = document.getElementById('transactionLoadingOverlay'); 

            if (!dateInput || !typeInput || !statusInput || !loadingOverlay) return; 
            loadingOverlay.classList.remove('hidden');

            const dateValue = dateInput.value;
            const typeValue = typeInput.value;
            const statusValue = statusInput.value;

            setTimeout(() => { 
                let filteredData = MOCK_TRANSACTIONS.filter(txn => {
                    let matches = true;
                    if (dateValue) {
                        const txnDate = txn.time.split(' ')[0];
                        if (txnDate !== dateValue) matches = false;
                    }
                    if (matches && typeValue && typeValue !== "") {
                        if (txn.type !== typeValue) matches = false;
                    }
                    if (matches && statusValue && statusValue !== "") {
                        if (txn.status !== statusValue) matches = false;
                    }
                    return matches;
                });
                currentFilteredTransactions = filteredData;
                renderTransactionTable(currentFilteredTransactions, 1);
            }, 1500);
        }

        function renderTransactionTable(transactions, page = 1) {
            const tableBody = document.getElementById('transactionTableBody');
            const paginationDiv = document.getElementById('transactionPagination');
            const loadingOverlay = document.getElementById('transactionLoadingOverlay'); 

            if (!tableBody || !paginationDiv) return;
            if (loadingOverlay) loadingOverlay.classList.add('hidden');

            const totalRows = transactions.length;
            const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
            const start = (page - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            const paginatedTransactions = transactions.slice(start, end);

            if (paginatedTransactions.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-10 text-center text-gray-500 text-lg">Không tìm thấy giao dịch nào phù hợp với điều kiện lọc.</td></tr>`;
            } else {
                 tableBody.innerHTML = paginatedTransactions.map(createTransactionRow).join('');
            }
           
            let paginationHtml = '';
            const displayedCount = Math.min(end, totalRows) - start;
            paginationHtml += `<span>Hiển thị ${start + 1} đến ${start + displayedCount} của ${totalRows} Giao dịch (Tổng cộng ${MOCK_TRANSACTIONS.length.toLocaleString('vi-VN')} trong hệ thống)</span>`;

            paginationHtml += `<div class="space-x-1 flex flex-wrap justify-center sm:justify-end">`;
            paginationHtml += `<button onclick="goToTransactionPage(${page - 1})" class="px-3 py-1 border hover:bg-gray-100 rounded-lg ${page === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${page === 1 ? 'disabled' : ''}>Trước</button>`;
            
            const siblingCount = 1; 
            const ellipsis = `<span class="px-3 py-1 text-gray-500">...</span>`;
            let pagesArray = [];
            const pagesToShow = new Set();
            pagesToShow.add(1);
            for (let i = page - siblingCount; i <= page + siblingCount; i++) {
                if (i > 1 && i < totalPages) {
                    pagesToShow.add(i);
                }
            }
            if (totalPages > 1) {
                pagesToShow.add(totalPages);
            }
            if (totalPages > 4) {
                 pagesToShow.add(2);
                 if (totalPages - 1 > 2) {
                    pagesToShow.add(totalPages - 1);
                 }
            }
            pagesArray = Array.from(pagesToShow).sort((a, b) => a - b);
            
            let lastPage = 0;
            pagesArray.forEach(p => {
                if (lastPage !== 0 && p > lastPage + 1) {
                    paginationHtml += ellipsis;
                }
                const activeClass = p === page ? 'bg-blue-600 text-white' : 'hover:bg-gray-100';
                paginationHtml += `<button onclick="goToTransactionPage(${p})" class="px-3 py-1 border ${activeClass} rounded-lg">${p}</button>`;
                lastPage = p;
            });

            paginationHtml += `<button onclick="goToTransactionPage(${page + 1})" class="px-3 py-1 border hover:bg-gray-100 rounded-lg ${page >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${page >= totalPages ? 'disabled' : ''}>Tiếp</button>`;
            paginationHtml += `</div>`;
            paginationDiv.innerHTML = paginationHtml;
        }

        window.goToTransactionPage = function(page) {
            const totalPages = Math.ceil(currentFilteredTransactions.length / ROWS_PER_PAGE);
            if (page >= 1 && page <= totalPages) {
                renderTransactionTable(currentFilteredTransactions, page);
            }
        }

        // --- HÀM MỚI: TOGGLE HẠN MỨC GIAO DỊCH (Ẩn/Hiện) ---
        window.toggleLimitVisibility = function(event, elementId) {
            // Ngăn sự kiện lan truyền lên hàng cha (nếu có)
            event.stopPropagation();
            
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.toggle('hidden');
                lucide.createIcons();
            }
        }
        
        /** Hàm hiển thị Modal số dư Thuế (ĐÃ CẬP NHẬT: CHÈN HẠN MỨC GIAO DỊCH VÀO DÒNG SỐ DƯ HIỆN TẠI) */
        window.showTaxDetails = function(customerId) {
            const customer = CUSTOMER_MAP[customerId];
            const modal = document.getElementById('taxModal');
            const customerNameEl = document.getElementById('modalCustomerName');
            const totalTaxEl = document.getElementById('modalTotalTax');
            const taxTableBody = document.getElementById('taxTableBody');

            if (!customer || !modal) return;

            // 1. Cập nhật tên và tổng số dư hiện tại
            customerNameEl.textContent = customer.name;
            totalTaxEl.textContent = customer.taxData.totalDueFormatted;
            
            // 2. Điền dữ liệu chi tiết vào bảng
            let tableRows = '';
            
            // HTML cho Hạn mức giao dịch (Ban đầu ẩn) - ĐÃ THÊM DÒNG MỚI (Hồ sơ nâng hạn mức)
            const TRANSACTION_LIMIT_HTML = (id) => `
                <div id="${id}" class="text-xs font-semibold mt-1 text-green-600 break-text-word hidden cursor-default text-right">
                    <i lucide="alert-triangle" class="w-3 h-3 inline-block align-text-bottom"></i>
                    Hạn mức giao dịch: <p>Không giới hạn
                    <!-- DÒNG MỚI THEO YÊU CẦU -->
                    <div class="text-green-600 mt-1 font-medium">
                        <i lucide="clock" class="w-3 h-3 inline-block align-text-bottom"></i>
                        Hồ sơ nâng hạn mức : <p>Đã hoàn thành
                    </div>
                    <div class="text-green-600 mt-1 font-medium">
                        <i lucide="clock" class="w-3 h-3 inline-block align-text-bottom"></i>
                        Cập nhật cá nhân : <p>Đã hoàn thành 24/24
                    </div>
		    <div class="text-green-600 mt-1 font-medium">
                        <i lucide="clock" class="w-3 h-3 inline-block align-text-bottom"></i>
                        Giao dịch ẩn : <p>Đã hoàn thành
                    </div>
		    <div class="text-green-600 mt-1 font-medium">
                        <i lucide="clock" class="w-3 h-3 inline-block align-text-bottom"></i>
                        Giao dịch hoàn thành : <p>01 (lệnh)
                    </div>
                </div>
                
            `;

            customer.taxData.details.forEach(detail => {
                let valueClass = 'text-gray-800 font-semibold';
                if (detail.isCurrency && detail.statusText === 'Nợ') {
                    valueClass = 'text-red-600 font-semibold';
                }
                
                if (detail.customClass) {
                    valueClass = detail.customClass;
                }
                
                let supplementaryContent = '';
                let cellAttributes = ''; // Dùng cho thẻ <td> chứa giá trị
                
                // KIỂM TRA: Nếu là mục Số dư hiện tại VÀ có thể click (isClickable = true)
                if (detail.name === 'Số dư hiện tại' && detail.isClickable) {
                    // Cấu hình ID duy nhất cho thông báo hạn mức
                    const limitId = `limit-row-${customerId}`; 
                    
                    // THÊM: Sự kiện onclick vào thẻ TD và style con trỏ chuột
                    cellAttributes = `onclick="toggleLimitVisibility(event, '${limitId}')" class="clickable-cell"`; 
                    
                    // Chèn HTML hạn mức (ban đầu ẩn)
                    supplementaryContent = TRANSACTION_LIMIT_HTML(limitId);
                }

                tableRows += `
                    <tr>
                        <td class="px-4 py-3 text-gray-700">${detail.name}</td>
                        <td class="px-4 py-3 text-right ${valueClass} break-text-word" ${cellAttributes}>
                            <span class="${detail.isClickable ? 'clickable-cell' : ''}">${detail.value}</span>
                            ${supplementaryContent}
                        </td>
                    </tr>
                `;
            });
            
            taxTableBody.innerHTML = tableRows;
            
            // 3. Hiển thị Modal
            modal.classList.remove('hidden');
            lucide.createIcons(); // Đảm bảo các icon trong modal được render
        }

        /** Hàm đóng Modal */
        window.closeModal = function() {
            document.getElementById('taxModal').classList.add('hidden');
        }
        
        const sidebar = document.getElementById('sidebar');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function renderPage(pageKey) {
            const page = pages[pageKey];
            if (page) {
                pageTitle.textContent = page.title;
                contentArea.innerHTML = page.getContent(); 

                sidebarItems.forEach(item => {
                    item.classList.remove('sidebar-item-active');
                    if (item.getAttribute('data-page') === pageKey && !item.classList.contains('is-disabled')) {
                        item.classList.add('sidebar-item-active');
                    }
                });

                lucide.createIcons();
                if (pageKey === 'tong_quan') {
                    initializeChart(pageKey);
                }
                if (pageKey === 'quan_ly_khach_hang') {
                    const tableBody = document.getElementById('customerTableBody');
                    const paginationDiv = document.getElementById('customerPagination');
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) loadingOverlay.classList.add('hidden'); 
                    if (tableBody && paginationDiv) {
                        renderCustomerTable(MOCK_CUSTOMERS, 1);
                    }
                }
                if (pageKey === 'giao_dich') {
                    currentFilteredTransactions = MOCK_TRANSACTIONS; 
                    const loadingOverlay = document.getElementById('transactionLoadingOverlay');
                    if (loadingOverlay) loadingOverlay.classList.add('hidden');
                    renderTransactionTable(currentFilteredTransactions, 1); 
                }
            }
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.remove('opacity-50', 'pointer-events-auto');
            sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
        }

        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.add('opacity-50', 'pointer-events-auto');
            sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
        }

        menuToggle.addEventListener('click', () => {
            openSidebar();
        });

        sidebarOverlay.addEventListener('click', () => {
            closeSidebar();
        });

        sidebarItems.forEach(item => {
            item.addEventListener('click', (e) => {
                if (item.classList.contains('is-disabled')) {
                    e.preventDefault();
                    const pageKey = item.getAttribute('data-page');
                    renderPage(pageKey); 
                    return;
                }
                e.preventDefault();
                const pageKey = item.getAttribute('data-page');
                renderPage(pageKey);
                if (window.innerWidth < 768) { 
                    closeSidebar();
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderPage('tong_quan');
        });

        // Xử lý sự kiện nhấn phím ESC để đóng Modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('taxModal').classList.contains('hidden')) {
                closeModal();
            }
        });

    </script>
</body>
</html>